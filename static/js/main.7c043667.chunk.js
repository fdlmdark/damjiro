(this.webpackJsonpdamjiro=this.webpackJsonpdamjiro||[]).push([[0],{181:function(e,t,a){e.exports=a(259)},186:function(e,t,a){},259:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),c=a(13),i=a.n(c),o=(a(186),a(15)),u=a.n(o),l=a(33),s=a(9),m=a(137),f=a(32),p=a(78),d=a(34),E=a(12),h=a(154),g=a(85),b=a(96),v=a(109),O=a.n(v),y=a(141),j=a(66),k=a.n(j),x=a(53),w=a.n(x),S=a(142),N=a(143),_=a(160),C=a(159),I=a(161),T=a(144),A=a.n(T),R=a(294),M=a(296),F=a(148),L=a.n(F),U=a(26);function D(e){var t=new k.a(e).getMidiEvents().filter((function(e){return e.subtype===w.a.EVENT_MIDI_NOTE_ON}));if(0===t.length)throw new Error("invalid midi file");return t[0]}var P=function(e){Object(_.a)(a,e);var t=Object(C.a)(a);function a(e,n){var r;return Object(S.a)(this,a),(r=t.call(this)).stop=function(){r._playing&&(r._source.stop(),r._playing=!1,r.emit("end"))},r._audioContext=e,r._pcm=n,r._playing=!1,r._currentTime=0,r._offset=0,r._epoch=null,r}return Object(N.a)(a,[{key:"play",value:function(){if(!this._playing){for(var e=this._audioContext.createBuffer(this._pcm.numChannels,this._pcm.data.length/this._pcm.numChannels,this._pcm.sampleRate),t=0;t<this._pcm.numChannels;t++)for(var a=e.getChannelData(t),n=0;n<a.length;n++){var r=(this._offset+n)*this._pcm.numChannels+t,c=r<this._pcm.data.length?this._pcm.data[r]/32767:0;a[n]=c}this._source=this._audioContext.createBufferSource(),this._source.buffer=e,this._source.connect(this._audioContext.destination),this._source.onended=this.stop,this._epoch=this._audioContext.currentTime+.1,this._source.start(this._epoch),this._playing=!0,this.emit("start")}}},{key:"getCurrentTime",value:function(){return this._epoch?this._audioContext.currentTime-this._epoch:0}}]),a}(A.a);var B=function(e){var t=e.buffer,a=e.onReady,c=e.onPlay,i=e.onEnd,o=Object(n.useState)(null),m=Object(s.a)(o,2),p=m[0],d=m[1],E=Object(n.useState)(null),h=Object(s.a)(E,2),g=h[0],b=h[1],v=Object(n.useState)(!1),O=Object(s.a)(v,2),y=O[0],j=O[1],k=Object(n.useRef)(a),x=Object(n.useRef)(c),w=Object(n.useRef)(i),S=Zt();return Object(n.useEffect)((function(){var e=new AudioContext;return d(e),function(){e.close()}}),[]),Object(n.useEffect)((function(){function e(){return(e=Object(l.a)(u.a.mark((function e(){var a,n,r,c,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=new I.a("https://ushitora-anqou.github.io/damjiro","\nsoundfont GeneralUserGSv1.471.sf2\n",{sampleRate:p.sampleRate,numChannels:2});case 1:if(a.isReady()){e.next=6;break}return e.next=4,new Promise((function(e){return setTimeout(e,1e3)}));case 4:e.next=1;break;case 6:return e.next=8,a.midi2wav(new Uint8Array(t));case 8:n=e.sent,r=D(t).playTime/1e3*n.sampleRate*n.numChannels,(c=Object(f.a)({},n,{data:new Int16Array(r+n.data.length)})).data.set(n.data,r),i=new P(p,c),k.current&&k.current({target:i}),i.on("start",(function(){x.current&&x.current(),j(!0)})),i.on("end",(function(){w.current&&w.current(),j(!1)})),b((function(e){return e&&e.stop(),i}));case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}p&&t&&function(){e.apply(this,arguments)}()}),[t,p]),k.current=a,x.current=c,w.current=i,y?r.a.createElement(R.a,{size:"large",variant:"outlined",onClick:function(){return g.stop()}},r.a.createElement(L.a,{className:S.wrapIcon}),"Stop"):g?r.a.createElement(R.a,{size:"large",variant:"outlined",onClick:function(){return g.play()}},r.a.createElement(M.a,{className:S.wrapIcon}),"Play"):r.a.createElement(U.a,{component:"sub"},"Loading...")};var G=a(162),W=a(301),K=a(349),V=a(304),z=a(305),q=a(297),J=a(298),H=a(299),$=a(300),Y=a(306),X=a(95),Q=a(302),Z=a(4),ee={success:q.a,warning:J.a,error:H.a,info:$.a},te=Object(W.a)((function(e){return{success:{backgroundColor:X.a[600]},error:{backgroundColor:e.palette.error.dark},info:{backgroundColor:e.palette.primary.main},warning:{backgroundColor:Q.a[700]},icon:{fontSize:20},iconVariant:{opacity:.9,marginRight:e.spacing(1)},message:{display:"flex",alignItems:"center"}}})),ae=Object(E.c)((function(e){var t=e.snack;return{openSnack:t.openSnack,variant:t.variant,message:t.message}}))((function(e){var t=e.openSnack,a=e.variant,n=e.message,c=e.dispatch,i=Object(G.a)(e,["openSnack","variant","message","dispatch"]),o=function(){return c({type:"SNACK_UNLOAD"})},u=te();a=Object.keys(ee).includes(a)?a:"info";var l=ee[a];return r.a.createElement(K.a,Object.assign({anchorOrigin:{vertical:"bottom",horizontal:"center"},open:t,onClose:o},i),r.a.createElement(V.a,{className:Object(Z.a)(u[a]),"aria-describedby":"snackbar",message:r.a.createElement("span",{id:"snackbar",className:u.message},r.a.createElement(l,{className:Object(Z.a)(u.icon,u.iconVariant)}),n),action:[r.a.createElement(z.a,{key:"close","aria-label":"close",color:"inherit",onClick:o},r.a.createElement(Y.a,{className:u.icon}))]}))})),ne=a(52),re=a(135),ce=a(43),ie=a(307),oe=a(308),ue=a(309),le=a(310),se=a(312),me=a(315),fe=a(19),pe=a(311),de=a(313),Ee=a(314),he=a(316),ge=a(63),be=Object(W.a)((function(e){return{nested:{paddingLeft:e.spacing(8)},root:{backgroundColor:e.palette.background.paper}}})),ve=Object(E.c)(null,{push:fe.d})((function(e){var t=e.push,a=Zt(),n=be();return r.a.createElement(ie.a,null,r.a.createElement(U.a,null,"\u3042\u3070\u3046\u3068\u307a\u30fc\u3058\u2606\u5f61"),r.a.createElement(oe.a,{component:"nav",className:n.root},r.a.createElement(ue.a,null,r.a.createElement(le.a,null,r.a.createElement(pe.a,{className:a.wrapIcon})),r.a.createElement(se.a,{primary:"Sing a song"})),r.a.createElement(ue.a,{button:!0,onClick:function(){return t("/gakufu/sing")},className:n.nested},r.a.createElement(le.a,null,r.a.createElement(de.a,{className:a.wrapIcon})),r.a.createElement(se.a,{primary:"from damjiro Gakufu"}),r.a.createElement(Ee.a,null)),r.a.createElement(ue.a,{button:!0,onClick:function(){return t("/midi/sing")},className:n.nested},r.a.createElement(le.a,null,r.a.createElement(ge.a,{icon:["far","file-audio"],className:a.wrapAwesomeIcon})),r.a.createElement(se.a,{primary:"from MIDI file"}),r.a.createElement(Ee.a,null)),r.a.createElement(me.a,null),r.a.createElement(ue.a,{button:!0,onClick:function(){return t("/gakufu/make")}},r.a.createElement(le.a,null,r.a.createElement(he.a,{className:a.wrapIcon})),r.a.createElement(se.a,{primary:"Make damjiro Gakufu"}),r.a.createElement(Ee.a,null))))})),Oe=a(327),ye=a(328),je=a(46),ke=function(e,t,a){try{if(["audio/midi","audio/x-midi","audio/mid"].includes(e.type)){var n=new FileReader;n.onload=function(e){return t(e.target.result)},n.readAsArrayBuffer(e)}else a({type:"SNACK_LOAD",message:"Invalid mime type",variant:"error"})}catch(r){a({type:"SNACK_LOAD",message:r.toString(),variant:"error"})}},xe=a(317),we=a(318),Se=a(326),Ne=a(263),_e=a(149),Ce=a.n(_e),Ie=a(323),Te=a(322),Ae=a(347),Re=a(324),Me=a(325),Fe=a(319),Le=a(342),Ue=a(345);function De(e,t){var a={notes:e.map((function(e){return[Math.round(e.tpos),Math.round(e.duration),Math.round(e.pitch)]})),youtubeVideoId:t};return JSON.stringify(a)}var Pe=Ce()({alternativeLabel:{top:22},active:{"& $line":{backgroundImage:"linear-gradient( 136deg, #000046 0%, #1CB5E0 80%)"}},completed:{"& $line":{backgroundImage:"linear-gradient( 136deg, #000046 0%, #1CB5E0 80%)"}},line:{height:3,border:0,backgroundColor:"#eaeaf0",borderRadius:1}})(Ne.a),Be=Object(W.a)({root:{backgroundColor:"#cccccc",zIndex:1,color:"#ffffff",width:50,height:50,display:"flex",borderRadius:"50%",justifyContent:"center",alignItems:"center"},active:{backgroundImage:"linear-gradient( 136deg, #1CB5E0 20%, #000046 100%)",boxShadow:"0 4px 10px 0 rgba(0,0,0,.25)"},completed:{backgroundImage:"linear-gradient( 136deg, #1CB5E0 20%, #000046 100%)"},font:{fontSize:"24px"}});function Ge(e){var t,a=Be(),n=e.active,c=e.completed,i={1:r.a.createElement(ge.a,{icon:["far","file-audio"],fontSize:500}),2:r.a.createElement(xe.a,null),3:r.a.createElement(we.a,null)};return r.a.createElement("div",{className:Object(Z.a)(a.root,(t={},Object(je.a)(t,a.active,n),Object(je.a)(t,a.completed,c),t),a.font)},i[String(e.icon)])}var We=Object(W.a)((function(e){return{root:{width:"100%"},button:{marginRight:e.spacing(1)},videoFrame:{width:"640px",height:"360px"}}}));function Ke(e){var t=e.dispatch,a=e.push,c=We(),i=Object(n.useState)(0),o=Object(s.a)(i,2),u=o[0],l=o[1],m=["Select midi file","Input youtube Id","Check output Gakufu"],f=Object(n.useState)(""),p=Object(s.a)(f,2),d=p[0],E=p[1],h=Object(n.useState)(0),b=Object(s.a)(h,2),v=b[0],O=b[1],y=Object(n.useState)(0),j=Object(s.a)(y,2),k=j[0],x=j[1],w=Object(n.useState)(0),S=Object(s.a)(w,2),N=S[0],_=S[1],C=Object(n.useState)(0),I=Object(s.a)(C,2),T=I[0],A=I[1],M=Object(n.useState)(""),F=Object(s.a)(M,2),L=F[0],D=F[1],P=Object(n.useState)(null),B=Object(s.a)(P,2),G=B[0],W=B[1],K=Object(n.useRef)(""),V=[],z=[];if(d)try{V=Pt(d,v,k),z=function(e,t,a){if(0===e.length)return e;var n=e[0].tpos;return e.map((function(e){return{tpos:e.tpos-n+t,duration:e.duration,pitch:e.pitch+a}}))}(V,1e6*N,T),K.current=null}catch(q){K.current=q.message}return Object(n.useEffect)((function(){if(0!==V.length){var e=V[0].tpos/1e6;_(e)}}),[d,v,k]),Object(n.useEffect)((function(){G&&G.seekTo(N,!0)}),[G,N]),r.a.createElement("div",{className:c.root},r.a.createElement(Te.a,{alternativeLabel:!0,activeStep:u,connector:r.a.createElement(Pe,null)},m.map((function(e){return r.a.createElement(Ie.a,{key:e},r.a.createElement(Ae.a,{StepIconComponent:Ge},e))}))),r.a.createElement("div",null,u===m.length?r.a.createElement(r.a.Fragment,null,r.a.createElement(Re.a,null,r.a.createElement(U.a,{className:c.instructions},"Let's sing with your Gakufu!")),r.a.createElement(Me.a,null,r.a.createElement(Fe.a,{container:!0,direction:"row",justify:"space-around"},r.a.createElement(Fe.a,{item:!0},r.a.createElement(R.a,{onClick:function(){a("/")},className:c.button},r.a.createElement(Se.a,null),"Back to Top"))))):r.a.createElement("div",null,r.a.createElement(Re.a,null,function(e){switch(e){case 0:return r.a.createElement(r.a.Fragment,null,r.a.createElement(Fe.a,{container:!0,direction:"column",justify:"center",spacing:2},r.a.createElement(Fe.a,{item:!0,container:!0,direction:"row",justify:"center",spacing:2},r.a.createElement(Fe.a,{item:!0},r.a.createElement(Le.a,{type:"file",accept:"audio/midi, audio/x-midi, audio/mid",InputLabelProps:{shrink:!0},variant:"outlined",onChange:function(e){E(""),O(0),x(0),_(0),A(0),D(""),W(null),K.current="";var a=e.target.files[0];ke(a,E,t)},label:"Select a midi file."})),r.a.createElement(me.a,{orientation:"vertical",flexItem:!0}),r.a.createElement(Fe.a,{item:!0},r.a.createElement(Le.a,{label:"Track No.",type:"number",onChange:function(e){return O(Number(e.target.value))},value:v,InputLabelProps:{shrink:!0},variant:"outlined"})),r.a.createElement(Fe.a,{item:!0},r.a.createElement(Le.a,{label:"Channel No.",type:"number",onChange:function(e){return x(Number(e.target.value))},value:k,InputLabelProps:{shrink:!0},variant:"outlined"})),r.a.createElement(Fe.a,{item:!0},r.a.createElement(Le.a,{label:"pitch offset (SMF note #)",type:"number",onChange:function(e){return A(Number(e.target.value))},value:T,InputLabelProps:{shrink:!0},variant:"outlined"})))),r.a.createElement(Wt,{curtpos:0,gNotes:z,uNotes:[],seconds:30}));case 1:return r.a.createElement(Fe.a,{container:!0,direction:"row",wrap:"wrap",justify:"space-around",spacing:2},r.a.createElement(Fe.a,{item:!0,style:{maxWidth:"300px"},xl:3,lg:12,container:!0,direction:"column",spacing:2},r.a.createElement(Fe.a,{item:!0},r.a.createElement(Le.a,{fullWidth:!0,label:"YouTube video id",type:"text",onChange:function(e){return D(String(e.target.value))},InputLabelProps:{shrink:!0},variant:"outlined"})),r.a.createElement(Fe.a,{item:!0},r.a.createElement(Le.a,{fullWidth:!0,label:"intro time (sec)",type:"number",step:"any",onChange:function(e){return _(Number(e.target.value))},value:N,InputLabelProps:{shrink:!0},variant:"outlined"}))),r.a.createElement(Ue.a,{mdDown:!0},r.a.createElement(me.a,{orientation:"vertical",flexItem:!0})),r.a.createElement(Fe.a,{item:!0,style:{maxWidth:"640px"},xl:9,lg:12},L?r.a.createElement(g.a,{videoId:L,onReady:function(e){var t=e.target;W(t),t.playVideo(),t.pauseVideo()}}):r.a.createElement("div",{className:c.videoFrame})));case 2:return r.a.createElement(Fe.a,{item:!0,container:!0,direction:"row",justify:"center",spacing:3},r.a.createElement(Fe.a,{item:!0,xs:10},r.a.createElement(Le.a,{fullWidth:!0,multiline:!0,rows:8,label:"Output Gakufu",value:d&&L?De(z,L):"",readOnly:!0,InputLabelProps:{shrink:!0},variant:"outlined"})),r.a.createElement(Fe.a,{item:!0},r.a.createElement(U.a,null,K.current)));default:return void t({type:"SNACK_LOAD",message:"Unknown step Error",variant:"error"})}}(u)),r.a.createElement(Me.a,null,r.a.createElement(Fe.a,{container:!0,direction:"row",justify:"space-around"},r.a.createElement(Fe.a,{item:!0},r.a.createElement(R.a,{disabled:0===u,onClick:function(){l((function(e){return e-1}))},className:c.button},r.a.createElement(Se.a,null),"Back")),r.a.createElement(Fe.a,{item:!0},r.a.createElement(R.a,{variant:"contained",color:"primary",onClick:function(){l((function(e){return e+1}))},className:c.button,disabled:function(e){switch(e){case 0:return!d;case 1:return!L;case 2:return!1;default:return!0}}(u)},u===m.length-1?"Finish":"Next",r.a.createElement(Ee.a,null))))))))}var Ve=Ke=Object(E.c)(null,{push:fe.d})(Ke),ze=function(){var e=Zt(),t=ea();return r.a.createElement(ie.a,null,r.a.createElement(Oe.a,{className:t.m3},r.a.createElement(ye.a,{title:r.a.createElement(U.a,{variant:"h5"},r.a.createElement(he.a,{className:e.wrapIcon}),"Make Damjiro Gakuhu.")}),r.a.createElement(Ve,null)))},qe=a(29),Je=a(343),He=a(329),$e=a(150),Ye=a.n($e),Xe=Object(E.c)((function(e){return{search:e.router.location.search}}))((function(e){var t=e.search,a=Ye.a.parse(t.slice(1)),n=Number(a.status);return r.a.createElement(Fe.a,{container:!0,direction:"row",justify:"center"},r.a.createElement(Fe.a,{item:!0,xs:8},r.a.createElement(Je.a,{severity:"error"},r.a.createElement(He.a,null,n),function(e){switch(e){case 404:return"Not Found";default:return"Unexpected Error"}}(n))))})),Qe=a(332),Ze=a(330),et=a(331),tt=function(){var e=Zt(),t=ea(),a=Object(n.useState)(!1),c=Object(s.a)(a,2),i=c[0],o=c[1];return r.a.createElement(ie.a,null,r.a.createElement(Oe.a,{className:t.m3},r.a.createElement(ye.a,{title:r.a.createElement(U.a,{variant:"h5"},r.a.createElement(pe.a,{className:e.wrapIcon}),"Sing a song")}),r.a.createElement(Re.a,null,r.a.createElement(Fe.a,{className:t.mt2,container:!0,direction:"row",justify:"space-around"},r.a.createElement(Fe.a,{item:!0,xs:5},r.a.createElement(U.a,{variant:"h6",className:t.mb2,color:"textSecondary"},r.a.createElement(de.a,{className:e.wrapIcon}),"From Damjiro Gakufu file."),r.a.createElement(Kt,null)))),r.a.createElement(Re.a,null,r.a.createElement(qt,null)),r.a.createElement(Me.a,{disableSpacing:!0},r.a.createElement(U.a,{color:"textSecondary",className:t.ml1},r.a.createElement(Ze.a,{className:e.wrapIcon}),"Adjustment"),r.a.createElement(z.a,{className:Object(Z.a)(e.expand,Object(je.a)({},e.expandOpen,i)),onClick:function(){o(!i)},"aria-expanded":i,"aria-label":"show more"},r.a.createElement(et.a,null))),r.a.createElement(Qe.a,{in:i,timeout:"auto",unmountOnExit:!0},r.a.createElement(Fe.a,{container:!0,spacing:5,direction:"row",className:t.collapse},r.a.createElement(Fe.a,{item:!0,xs:3},r.a.createElement(Vt,null)),r.a.createElement(Fe.a,{item:!0,xs:3},r.a.createElement(zt,null))))))},at=a(333),nt=a(346);function rt(e){var t=e.onLoad,a=e.dispatch;return r.a.createElement(Le.a,{type:"file",label:"Select a midi file.",accept:"audio/midi, audio/x-midi, audio/mid",onChange:function(e){var n=e.target.files[0];ke(n,t,a)},InputLabelProps:{shrink:!0},variant:"outlined"})}var ct=rt=Object(E.c)()(rt),it=Object(E.c)()((function(e){var t=e.dispatch,a=Zt(),c=ea(),i=Object(n.useState)(!1),o=Object(s.a)(i,2),u=o[0],l=o[1],m=Object(n.useState)(!1),f=Object(s.a)(m,2),p=f[0],d=f[1];return console.log(p),r.a.createElement(ie.a,null,r.a.createElement(Oe.a,{className:c.m3},r.a.createElement(ye.a,{title:r.a.createElement(U.a,{variant:"h5"},r.a.createElement(pe.a,{className:a.wrapIcon}),"Sing a song")}),r.a.createElement(Re.a,null,r.a.createElement(Fe.a,{className:c.mt2,container:!0,direction:"row",justify:"space-around"},r.a.createElement(Fe.a,{item:!0,xs:5,container:!0,direction:"column",justify:"space-between"},r.a.createElement(U.a,{variant:"h6",color:"textSecondary",className:c.mb2},r.a.createElement(ge.a,{icon:["far","file-audio"],className:a.wrapIcon}),"From midi file."),r.a.createElement(ct,{onLoad:function(e){t({type:"SET_GAKUFU",gakufu:{notes:Pt(e,0,0),midiBuf:p?Bt(e,0,0):e,videoId:null}})}}),r.a.createElement(at.a,{control:r.a.createElement(nt.a,{checked:p,onChange:function(e){return d(e.target.checked)},name:"checkedMute"}),label:"Mute melody"})))),r.a.createElement(Re.a,null,r.a.createElement(qt,null)),r.a.createElement(Me.a,{disableSpacing:!0},r.a.createElement(U.a,{color:"textSecondary",className:c.ml1},r.a.createElement(Ze.a,{className:a.wrapIcon}),"Adjustment"),r.a.createElement(z.a,{className:Object(Z.a)(a.expand,Object(je.a)({},a.expandOpen,u)),onClick:function(){l(!u)},"aria-expanded":u,"aria-label":"show more"},r.a.createElement(et.a,null))),r.a.createElement(Qe.a,{in:u,timeout:"auto",unmountOnExit:!0},r.a.createElement(Fe.a,{container:!0,spacing:5,direction:"row",className:c.collapse},r.a.createElement(Fe.a,{item:!0,xs:3},r.a.createElement(Vt,null)),r.a.createElement(Fe.a,{item:!0,xs:3},r.a.createElement(zt,null))))))})),ot=a(114),ut=Object(E.c)(null,{push:fe.d})((function(e){var t=e.push;return r.a.createElement(ie.a,null,r.a.createElement(Fe.a,{container:!0,direction:"row",justify:"center"},r.a.createElement(Fe.a,{item:!0},r.a.createElement(ot.a,{onClick:function(){return t("/")}},r.a.createElement(U.a,{variant:"h3"},"Damjiro")))))})),lt=a(334),st=Object(E.c)(null,{push:fe.d})((function(e){e.push;return r.a.createElement(ie.a,null,r.a.createElement(Fe.a,{container:!0,direction:"row",justify:"center"},r.a.createElement(Fe.a,{item:!0},r.a.createElement(U.a,{color:"textSecondary"},"Damjiro is under MIT License. You can contribute on GitHub at"," ",r.a.createElement(lt.a,{href:"https://github.com/ushitora-anqou/damjiro",target:"_blank",rel:"noreferrer"},"ushitora-anqou/damjiro"),"."))))})),mt=a(151),ft=a.n(mt),pt=a(348),dt=a(338),Et=a(336),ht=a(337),gt=a(335);function bt(){var e=Object(n.useState)(!1),t=Object(s.a)(e,2),a=t[0],c=t[1],i=Object(n.useState)(!0),o=Object(s.a)(i,2),u=o[0],l=o[1];Object(n.useEffect)((function(){try{var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");c(!(!window.WebGLRenderingContext||!t))}catch(a){c(!1)}}),[]);var m=function(){l(!1)};return a?r.a.createElement("div",null):r.a.createElement(pt.a,{open:u,onClose:m,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description"},r.a.createElement(gt.a,{id:"alert-dialog-title"},"WebGL is not enabled in your browser."),r.a.createElement(Et.a,null,r.a.createElement(ht.a,{id:"alert-dialog-description"},"Damjiro uses WebGL.")),r.a.createElement(dt.a,null,r.a.createElement(R.a,{onClick:m,color:"primary",autoFocus:!0},"OK")))}var vt=a(152),Ot=a.n(vt);function yt(e,t){return jt.apply(this,arguments)}function jt(){return(jt=Object(l.a)(u.a.mark((function e(t,a){var n,r,c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){var n=Ot.a.pitchDetection("https://ushitora-anqou.github.io/damjiro/model",t,a,(function(){e(n)}))}));case 2:return n=e.sent,r=function(){var e=Object(l.a)(u.a.mark((function e(){var t,a,r,c,i,o;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getPitch();case 2:if(t=e.sent,a=Object(s.a)(t,3),r=a[0],c=a[1],i=a[2],r){e.next=9;break}return e.abrupt("return",[null,c,i]);case 9:return o=Math.round(Math.log(r/440)/Math.log(2)*12)+69,e.abrupt("return",[o,c,i]);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),c=function(){},e.abrupt("return",[r,c]);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var kt=a(339);function xt(){return wt.apply(this,arguments)}function wt(){return(wt=Object(l.a)(u.a.mark((function e(){var t,a,n,r,c,i,o,l,m,f,p,d,E,h,g,b,v,O,y,j,k,x;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new AudioContext,a=10,e.next=4,navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1},video:!1});case 4:return n=e.sent,e.next=7,yt(t,n);case 7:for(r=e.sent,c=Object(s.a)(r,1),i=c[0],o=t.currentTime+2,l=0;l<a;l++)(m=t.createOscillator()).connect(t.destination),m.frequency.value=440,m.start(o+1*l),m.stop(o+1*l+.1);f=null,p=-1,d=[];case 15:if(!(t.currentTime<o+a+1)){e.next=35;break}return e.next=18,i();case 18:if(E=e.sent,h=Object(s.a)(E,3),g=h[0],b=h[1],v=h[2],69!==g||f&&f===v){e.next=33;break}if(O=v-b.duration-o,y=Math.floor(O),p===y){e.next=31;break}if(j=O-y,d.push(j),y!==a){e.next=31;break}return e.abrupt("break",35);case 31:p=y,f=v;case 33:e.next=15;break;case 35:if(n.getTracks().forEach((function(e){return e.stop()})),t.close(),0!==d.length){e.next=39;break}throw new Error("No audio detected");case 39:return k=d.reduce((function(e,t){return e+t}))/d.length,x=Math.sqrt(d.map((function(e){return Math.pow(e-k,2)})).reduce((function(e,t){return e+t}))/d.length),e.abrupt("return",[k,x]);case 42:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var St=Object(E.c)()((function(e){var t=e.dispatch,a=e.open,c=e.onDone,i=e.onCancel,o=Object(n.useState)(!1),m=Object(s.a)(o,2),f=m[0],p=m[1],d=function(){var e=Object(l.a)(u.a.mark((function e(){var a,n,r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p(!0),e.prev=1,e.next=4,xt();case 4:a=e.sent,n=Object(s.a)(a,2),r=n[0],n[1]<1?c(r):t({type:"SNACK_LOAD",message:"Couldn't estimate",variant:"error"}),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t({type:"SNACK_LOAD",message:e.t0.message,variant:"error"});case 14:p(!1);case 15:case"end":return e.stop()}}),e,null,[[1,11]])})));return function(){return e.apply(this,arguments)}}();return r.a.createElement(pt.a,{"aria-labelledby":"mic-latency-dialog-title",open:a},r.a.createElement(gt.a,{id:"mic-latency-dialog-title"},"Estimate mic's latency"),r.a.createElement(Et.a,{dividers:!0},r.a.createElement(U.a,{gutterBottom:!0},"Put your mic in front of your speaker/headphone."),r.a.createElement(U.a,{gutterBottom:!0},"Maximize the volume of your speaker. Also make sure your mic is working."),r.a.createElement(U.a,{gutterBottom:!0},"Let's start estimation!")),r.a.createElement(dt.a,null,f?r.a.createElement(kt.a,null):r.a.createElement(r.a.Fragment,null,r.a.createElement(R.a,{onClick:function(){i()},color:"primary"},"Cancel"),r.a.createElement(R.a,{autoFocus:!0,onClick:d,color:"primary"},"Start"))))})),Nt=a(321),_t=a(350),Ct=a(320),It=a(340),Tt=a(341),At=a(76),Rt=a(153);function Mt(){var e=Object(m.a)(["\n  max-width: 80vw;\n  width: inherit;\n"]);return Mt=function(){return e},e}function Ft(e){return 1e6*e}function Lt(e,t){return Math.abs(e-t)<1e-4}function Ut(e,t){return Math.floor(e/t)*t}function Dt(e,t){return function(a,n){for(var r=n-a;0!==r;){var c=Math.floor(r/2),i=a+c;t(e[i])?(r-=c+1,a=i+1):r=c}return a}(0,e.length)}function Pt(e,t,a){var n=new k.a(e);if(2===n.header.getFormat())throw new Error("Unsupported format of MIDI");if(0===n.header.getTracksCount())throw new Error("Not enough tracks");if(n.header.getTimeDivision()!==k.a.Header.TICKS_PER_BEAT)throw new Error("Unsupported time division");var r,c=[],i=[],o=n.getMidiEvents(),u=Object(p.a)(o);try{for(u.s();!(r=u.n()).done;){var l=r.value;if(l.channel===a)switch(l.subtype){case w.a.EVENT_MIDI_NOTE_ON:if(c.length!==i.length)break;c.push([1e3*l.playTime,l.param1]);break;case w.a.EVENT_MIDI_NOTE_OFF:if(c.length-i.length!==1||c[c.length-1][1]!==l.param1)break;i.push([1e3*l.playTime,l.param1])}}}catch(x){u.e(x)}finally{u.f()}if(c.length!==i.length)throw new Error("Invalid # of note offs");for(var s=[],m=0;m<c.length;m++){var d=c[m],E=i[m];s.push({tpos:d[0],duration:E[0]-d[0],pitch:d[1],lyrics:""})}if(0===s.length)return s;var h=n.getLyrics().map((function(e){return Object(f.a)({},e,{text:ft.a.convert(e.text,{to:"UNICODE"})})})),g=[{"\\":[1,!1],"^":[0,!1],"/":[0,!1],"%":[0,!1],"<":[0,!1],">":[0,!1],"[":[2,!1],"(":[2,!1]},{},{"]":[0,!1],")":[0,!1]}],b=[[0,!0],[0,!0],[2,!1]],v=0;h=h.map((function(e){var t,a="",n=Object(p.a)(e.text);try{for(n.s();!(t=n.n()).done;){var r=t.value,c=g[v][r]||b[v];c[1]&&(a+=r),v=c[0]}}catch(x){n.e(x)}finally{n.f()}return Object(f.a)({},e,{text:a})}));var O,y=Object(p.a)(h);try{var j=function(){var e=O.value,t=1e3*e.playTime,a=Dt(s,(function(e){return e.tpos<=t})),n=0===a?null:s[a-1],r=a===s.length?null:s[a],c=null;if(n&&Lt(n.tpos,t)?c=n:r&&Lt(t,r.tpos)?c=r:n&&n.tpos<t&&t<n.tpos+n.duration&&(c=n),!c)return"continue";c.lyrics+=e.text};for(y.s();!(O=y.n()).done;)j()}catch(x){y.e(x)}finally{y.f()}return s}function Bt(e,t,a){var n=new k.a(e);if(n.header.getTracksCount()<=t)throw new Error("Invalid track number");var r,c=n.getTrackEvents(t),i=Object(p.a)(c);try{for(i.s();!(r=i.n()).done;){var o=r.value;if(o.channel===a)switch(o.subtype){case w.a.EVENT_MIDI_NOTE_ON:o.param2=0}}}catch(u){i.e(u)}finally{i.f()}return n.setTrackEvents(t,c),n.getContent()}At.b.add(Rt.a);var Gt=h.a.svg(Mt());function Wt(e){var t,a,n,c=e.curtpos,i=e.gNotes,o=e.uNotes,u=e.seconds,l=i.reduce((function(e,t){return[Math.min(e[0],t.pitch-12),Math.max(e[1],t.pitch+12)]}),[Number.MAX_VALUE,Number.MIN_VALUE]),m=Object(s.a)(l,2),f=m[0],p=m[1],d=100*u,E=5*(p-f+1),h=function(e){return 100*e/1e6},g=Ut(h(c),d),b=Ut(h(c),d)+d,v=function(e){return h(e)-g},O=function(e){return e.filter((function(e){return g<h(e.tpos+e.duration)&&h(e.tpos)<b&&f<=e.pitch&&e.pitch<=p}))},y=function(e,t,a){return e.reduce((function(e,t){if(0===e.length)return[t];var n=e[e.length-1];return a&&n.pitch===t.pitch&&Lt(n.tpos+n.duration,t.tpos)?(e[e.length-1]={tpos:n.tpos,duration:t.tpos+t.duration-n.tpos,pitch:n.pitch},e):e.concat(t)}),[]).map((function(e){var n,c=a?h(e.duration):h(e.duration)-1;return r.a.createElement(r.a.Fragment,{key:e.tpos},e.lyrics&&r.a.createElement("text",{x:v(e.tpos),y:20,fontSize:20},e.lyrics),r.a.createElement("rect",{x:v(e.tpos),y:(n=e.pitch,E-5*(n-f)),width:c,height:5,rx:1,ry:1,fill:t,fillOpacity:.7}))}))};return r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,c),r.a.createElement(Gt,{viewBox:"0,0,"+d+","+E},r.a.createElement("line",{x1:0,x2:d,y1:0,y2:0,strokeWidth:5,stroke:"gray"}),r.a.createElement("line",{x1:0,x2:d,y1:E,y2:E,strokeWidth:5,stroke:"gray"}),(t=0,a=d,n=100,Array.from({length:(a-t)/n+1},(function(e,a){return t+a*n}))).map((function(e){return r.a.createElement("line",{key:e,x1:e,x2:e,y1:0,y2:E,strokeWidth:1,stroke:"gray",fillOpacity:.7})})),r.a.createElement("line",{x1:v(c),x2:v(c),y1:0,y2:E,strokeWidth:1,stroke:"red"}),y(O(i),"gray",!1),y(O(o.filter((function(e){return e.correct}))),"#FFA500",!0),y(O(o.filter((function(e){return!e.correct}))),"red",!0)))}function Kt(e){var t=e.dispatch,a=Object(n.useState)(""),c=Object(s.a)(a,2),i=c[0],o=c[1],u=Object(n.useState)(null),l=Object(s.a)(u,2),m=l[0],f=l[1];return r.a.createElement(Nt.a,{fullWidth:!0},r.a.createElement(Le.a,{value:i,label:"Enter Damjiro Gakuhu.",helperText:m,error:m,multiline:!0,rows:3,InputLabelProps:{shrink:!0},variant:"outlined",onChange:function(e){var a;if(t({type:"RESET_USER_NOTES"}),o(e.target.value),""!==e.target.value)try{var n=JSON.parse(e.target.value),r=n.notes.map((function(e){return{tpos:e[0],duration:e[1],pitch:e[2]}})),c=n.youtubeVideoId;"string"===typeof(a=c)||a instanceof String?(t({type:"SET_GAKUFU",gakufu:{notes:r,videoId:c}}),f(null)):t({type:"SNACK_LOAD",message:"invalid JSON",variant:"error"})}catch(e){t({type:"RESET_GAKUFU"}),f(e.message),t({type:"SNACK_LOAD",message:e.message,variant:"error"})}else f(null)}}))}function Vt(e){var t=e.timeOffset,a=e.dispatch,c=Object(n.useState)(!1),i=Object(s.a)(c,2),o=i[0],u=i[1];return r.a.createElement(r.a.Fragment,null,r.a.createElement(Nt.a,{fullWidth:!0},r.a.createElement(_t.a,null,"Offset"),r.a.createElement(Ct.a,{type:"number",value:Math.floor(t/1e3),onChange:function(e){return a({type:"SET_USER_TIME_OFFSET",value:1e3*Number(e.target.value)})},required:!0,endAdornment:r.a.createElement(It.a,{position:"end"},"ms")}),r.a.createElement(R.a,{variant:"contained",onClick:function(){return u(!0)}},"Estimate offset")),r.a.createElement(St,{open:o,onDone:function(e){a({type:"SET_USER_TIME_OFFSET",value:Ft(e)}),u(!1)},onCancel:function(){return u(!1)}}))}function zt(e){var t=e.pitchOffset,a=e.dispatch;return r.a.createElement(Nt.a,{fullWidth:!0},r.a.createElement(_t.a,null,"Pitch Offset"),r.a.createElement(Ct.a,{type:"number",value:Math.floor(t),onChange:function(e){return a({type:"SET_USER_PITCH_OFFSET",value:Number(e.target.value)})},required:!0,endAdornment:r.a.createElement(It.a,{position:"end"},"note#")}))}function qt(e){var t=e.dispatch,a=e.gakufu,c=e.user,i=c.notes,o=c.timeOffset,m=c.pitchOffset,f=ea(),p=Object(n.useRef)(null),d=Object(n.useRef)(!1),E=Object(n.useRef)(o),h=Object(n.useRef)(m),b=Object(n.useState)(0),v=Object(s.a)(b,2),O=v[0],y=v[1],j=Object(n.useRef)(null),k=Object(n.useCallback)(Object(l.a)(u.a.mark((function e(){var n,r,c,i,o,l,m,f,g,b,v,O,k;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!d.current){e.next=2;break}return e.abrupt("return");case 2:if(d.current=!0,t({type:"RESET_USER_NOTES"}),n=setInterval((function(){return y(1e3*j.current.getCurrentTime()*1e3)}),25),p.current){e.next=9;break}return e.next=8,navigator.mediaDevices.getUserMedia({audio:!0,video:!1});case 8:p.current=e.sent;case 9:return r=new AudioContext,e.next=12,yt(r,p.current);case 12:c=e.sent,i=Object(s.a)(c,2),o=i[0],l=i[1],m=function(){return Ft(j.current.getCurrentTime())-E.current},f=null;case 18:if(!d.current){e.next=31;break}return e.next=21,o();case 21:g=e.sent,b=Object(s.a)(g,3),v=b[0],O=b[1],k=b[2],v&&f!==k&&v>=36&&v<=88&&function(){var e=m(),n=Ft(r.currentTime),c=Ft(O.duration),i=e-(n-Ft(k)+c),o=v,u=!1,l=Dt(a.notes,(function(e){return e.tpos<i}))-1,s=l>=0?a.notes[l]:a.notes[0];if(s){o=s.pitch+h.current;var f=v-o-12*Math.floor((v-o)/12);f>6&&(f-=12),o+=f,s.tpos<i&&i<s.tpos+s.duration&&0===f&&(u=!0)}t({type:"APPEND_USER_NOTE",note:{tpos:i,duration:c,pitch:o,correct:u}})}(),O=null,f=k,e.next=18;break;case 31:l(),r.close(),clearInterval(n);case 34:case"end":return e.stop()}}),e)}))),[a.notes,t]),x=Object(n.useCallback)(Object(l.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:d.current=!1,p.current.getTracks().forEach((function(e){return e.stop()})),p.current=null;case 3:case"end":return e.stop()}}),e)}))),[d,p]);return E.current=o,h.current=m,r.a.createElement(r.a.Fragment,null,a.videoId&&r.a.createElement(g.a,{videoId:a.videoId,onReady:function(e){return j.current=e.target},onPlay:k,onPause:function(){return d.current=!1},onEnd:x}),a.notes&&r.a.createElement(Fe.a,{container:!0,direction:"row",wrap:"nowrap",alignItems:"flex-end"},r.a.createElement(Fe.a,{item:!0,className:f.mr2,style:{flexGrow:1}},r.a.createElement(Wt,{curtpos:O,gNotes:a.notes,uNotes:i,seconds:10})),r.a.createElement(Fe.a,{item:!0,className:f.mr2+" "+f.mt1,style:{maxWidth:"140px"},container:!0,direction:"column",spacing:2},r.a.createElement(Fe.a,{item:!0},a.midiBuf&&r.a.createElement(B,{buffer:a.midiBuf,onReady:function(e){t({type:"RESET_USER_NOTES"}),j.current=e.target,y(0)},onPlay:k,onEnd:x})),r.a.createElement(Fe.a,{item:!0},r.a.createElement(Jt,null)))))}function Jt(e){var t=e.gNotes,a=e.uNotes;if(!t||!a)return r.a.createElement("div",null);var n=a.reduce((function(e,a){var n=t[Dt(t,(function(e){return e.tpos<a.tpos}))-1];if(!n||n.tpos+n.duration<a.tpos)return e;var r,c=Math.abs(a.pitch-n.pitch);return e+a.duration*(1-(r=c)/(1+Math.abs(r)))}),0)/t.reduce((function(e,t){return e+t.duration}),0),c=a.reduce((function(e,a){var n=t[Dt(t,(function(e){return e.tpos<a.tpos}))-1];if(!n||n.tpos+n.duration<a.tpos)return e;Math.abs(a.pitch-n.pitch);return a.pitch===n.pitch?e+a.duration:e}),0)/a.reduce((function(e,t){return e+t.duration}),0),i=1.2*(100*n+0),o=isNaN(c)?0:100*c;return r.a.createElement(Fe.a,{container:!0,direction:"column",spacing:1},r.a.createElement(Fe.a,{item:!0},r.a.createElement(U.a,{variant:"h6"},"Score: ",Math.round(100*i)/100)),r.a.createElement(Fe.a,{item:!0},r.a.createElement(U.a,{variant:"h6"},"Accuracy: ",Math.round(100*o)/100)))}Kt=Object(E.c)()(Kt),Vt=Object(E.c)((function(e){return{timeOffset:e.user.timeOffset}}))(Vt),zt=Object(E.c)((function(e){return{pitchOffset:e.user.pitchOffset}}))(zt),qt=Object(E.c)((function(e){return{gakufu:e.gakufu,user:e.user}}))(qt),Jt=Object(E.c)((function(e){return{gNotes:e.gakufu.notes,uNotes:e.user.notes}}))(Jt);var Ht=Object(ce.a)({basename:"/damjiro/"}),$t=Object(d.c)({gakufu:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{notes:null,videoId:null,midiBuf:null},t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SET_GAKUFU":return t.gakufu;case"RESET_GAKUFU":return{notes:null,videoId:null};default:return e}},user:Object(b.a)({key:"user",storage:O.a,whitelist:["pitchOffset"]},(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{notes:[],timeOffset:3e5,pitchOffset:0},t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SET_USER_TIME_OFFSET":return Object(f.a)({},e,{timeOffset:t.value});case"SET_USER_PITCH_OFFSET":return Object(f.a)({},e,{pitchOffset:t.value});case"RESET_USER_NOTES":return Object(f.a)({},e,{notes:[]});case"APPEND_USER_NOTE":return Object(f.a)({},e,{notes:e.notes.concat(t.note)});default:return e}})),snack:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{loadSnack:!1,message:"",variant:""},t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SNACK_LOAD":return console.log("loaded",t),Object(f.a)({},e,{openSnack:!0,message:t.message,variant:t.variant});case"SNACK_UNLOAD":return console.log("unloaded",t),Object(f.a)({},e,{openSnack:!1});default:return e}},router:Object(ne.b)(Ht)}),Yt=Object(b.a)({key:"root",storage:O.a,whitelist:["user"]},$t),Xt=Object(d.e)(Yt,Object(d.d)(Object(d.a)(Object(re.a)(Ht)))),Qt=Object(b.b)(Xt),Zt=Object(W.a)((function(e){return{expand:{transform:"rotate(0deg)",marginLeft:"auto",transition:e.transitions.create("transform",{duration:e.transitions.duration.shortest})},expandOpen:{transform:"rotate(180deg)"},wrapIcon:{verticalAlign:"middle",display:"inline-flex",marginRight:e.spacing(1)},wrapAwesomeIcon:{verticalAlign:"middle",display:"inline-flex",marginRight:e.spacing(1),fontSize:"24px"}}})),ea=Object(W.a)((function(e){return{mt1:{marginTop:e.spacing(1)},mt2:{marginTop:e.spacing(2)},mt3:{marginTop:e.spacing(3)},mb1:{marginBottom:e.spacing(1)},mb2:{marginBottom:e.spacing(2)},m1:{margin:e.spacing(1)},m3:{margin:e.spacing(3)},ml1:{marginLeft:e.spacing(1)},collapse:{marginLeft:e.spacing(3),marginRight:e.spacing(3),marginBottom:e.spacing(3)},mr2:{marginRight:e.spacing(2)},mauto:{margin:"auto"}}}));var ta=function(){return r.a.createElement(E.a,{store:Xt},r.a.createElement(y.a,{loading:null,persistor:Qt},r.a.createElement(Tt.a,null),r.a.createElement(ut,null),r.a.createElement(bt,null),r.a.createElement(ne.a,{history:Ht},r.a.createElement(qe.d,null,r.a.createElement(qe.b,{exact:!0,path:"/",component:ve}),r.a.createElement(qe.b,{exact:!0,path:"/gakufu/make",component:ze}),r.a.createElement(qe.b,{exact:!0,path:"/gakufu/sing",component:tt}),r.a.createElement(qe.b,{exact:!0,path:"/midi/sing",component:it}),r.a.createElement(qe.b,{exact:!0,path:"/error",component:Xe}),r.a.createElement(qe.b,{render:function(){return r.a.createElement(qe.a,{to:"/error?status=404"})}}))),r.a.createElement(st,null),r.a.createElement(ae,null)))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(ta,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[181,1,2]]]);
//# sourceMappingURL=main.7c043667.chunk.js.map