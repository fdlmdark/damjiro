(this.webpackJsonpdamjiro=this.webpackJsonpdamjiro||[]).push([[0],{124:function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),u=n(9),o=n.n(u),c=(n(83),n(22)),i=n(35),s=n.n(i),l=n(12),f=n(57),d=n(44),p=n(58),m=n(17),h=n(11),v=n(68),g=n(46),b=n.n(g),E=n(40),O=n(47),y=n.n(O),_=n(60),j=n(61),S=n.n(j),k=n(32),N=n.n(k),T=n(26),w=n.n(T),C=n(13),x=n.n(C),A=n(62),R=n(29),I=n(30),M=n(37),U=n(20),F=n(15),P=n(72),D=n(73),K=n(65),L=n(66);function B(e){var t=new N.a(e).getMidiEvents().filter((function(e){return e.subtype===w.a.EVENT_MIDI_NOTE_ON}));if(0===t.length)throw new Error("invalid midi file");return t[0]}var V=function(e){Object(D.a)(n,e);var t=Object(P.a)(n);function n(e,r){var a;return Object(M.a)(this,n),(a=t.call(this))._audioContext=e,a._pcm=r,a._playing=!1,a._currentTime=0,a._offset=0,a._epoch=null,a._onAudioProcess=a._onAudioProcess.bind(Object(F.a)(a)),a}return Object(U.a)(n,[{key:"play",value:function(){this._playing||(this._node=this._audioContext.createScriptProcessor(0,0,this._pcm.numChannels),this._node.connect(this._audioContext.destination),this._node.addEventListener("audioprocess",this._onAudioProcess),this._playing=!0,this.emit("start"))}},{key:"stop",value:function(){this._playing&&(this._node.disconnect(),this._node.removeEventListener("audioprocess",this._onAudioProcess),this._playing=!1,this._pcm=null,this.emit("end"))}},{key:"_onAudioProcess",value:function(e){for(var t=0,n=0;n<this._pcm.numChannels;n++){var r=e.outputBuffer.getChannelData(n);t=r.length;for(var a=0;a<t;a++){var u=(this._offset+a)*this._pcm.numChannels+n,o=u<this._pcm.data.length?this._pcm.data[u]/32767:0;r[a]=o}}this._offset+=t,this._epoch||(this._epoch=this._audioContext.currentTime),this._playing&&this._offset*this._pcm.numChannels>this._pcm.data.length&&this.stop()}},{key:"getCurrentTime",value:function(){return this._epoch?this._audioContext.currentTime-this._epoch:0}}]),n}(n.n(L).a);var G=function(e){var t=e.buffer,n=e.onReady,u=e.onPlay,o=e.onEnd,c=Object(r.useState)(null),i=Object(I.a)(c,2),s=i[0],l=i[1],f=Object(r.useState)(null),d=Object(I.a)(f,2),p=d[0],m=d[1],h=Object(r.useState)(!1),v=Object(I.a)(h,2),g=v[0],b=v[1],E=Object(r.useRef)(n),O=Object(r.useRef)(u),y=Object(r.useRef)(o);return Object(r.useEffect)((function(){var e=new AudioContext;return l(e),function(){e.close()}}),[]),Object(r.useEffect)((function(){function e(){return(e=Object(R.a)(x.a.mark((function e(){var n,r,a,u,o;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=new K.a(window.location.pathname,"\nsoundfont GeneralUserGSv1.471.sf2\n",{sampleRate:s.sampleRate,numChannels:2});case 1:if(n.isReady()){e.next=6;break}return e.next=4,new Promise((function(e){return setTimeout(e,1e3)}));case 4:e.next=1;break;case 6:return e.next=8,n.midi2wav(new Uint8Array(t));case 8:r=e.sent,a=B(t).playTime/1e3*r.sampleRate*r.numChannels,(u=Object(A.a)({},r,{data:new Int16Array(a+r.data.length)})).data.set(r.data,a),o=new V(s,u),E.current&&E.current({target:o}),o.on("start",(function(){O.current&&O.current(),b(!0)})),o.on("end",(function(){y.current&&y.current(),b(!1)})),m((function(e){return e&&e.stop(),o}));case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}s&&t&&function(){e.apply(this,arguments)}()}),[t,s]),E.current=n,O.current=u,y.current=o,a.a.createElement("div",null,p&&!g&&a.a.createElement("button",{type:"button",onClick:function(e){return p.play()}},"Play"))},W=function(e,t,n){try{if(["audio/midi","audio/x-midi","audio/mid"].includes(e.type)){var r=new FileReader;r.onload=function(e){return t(e.target.result)},r.readAsArrayBuffer(e)}else n({type:"SNACK_LOAD",message:"Invalid mime type",variant:"error"})}catch(a){n({type:"SNACK_LOAD",message:a.toString(),variant:"error"})}};function J(e){var t=e.onLoad,n=e.dispatch;return a.a.createElement("input",{type:"file",accept:"audio/midi, audio/x-midi, audio/mid",onChange:function(e){var r=e.target.files[0];W(r,t,n)}})}var H=J=Object(h.b)()(J);var q=n(74),z=n(151),Y=n(155),$=n(157),Q=n(156),X=n(146),Z=n(148),ee=n(149),te=n(150),ne=n(153),re=n(39),ae=n(152),ue=n(3),oe={success:X.a,warning:Z.a,error:ee.a,info:te.a},ce=Object(z.a)((function(e){return{success:{backgroundColor:re.a[600]},error:{backgroundColor:e.palette.error.dark},info:{backgroundColor:e.palette.primary.main},warning:{backgroundColor:ae.a[700]},icon:{fontSize:20},iconVariant:{opacity:.9,marginRight:e.spacing(1)},message:{display:"flex",alignItems:"center"}}})),ie=Object(h.b)((function(e){var t=e.snack;return{openSnack:t.openSnack,variant:t.variant,message:t.message}}))((function(e){var t=e.openSnack,n=e.variant,r=e.message,u=e.dispatch,o=Object(q.a)(e,["openSnack","variant","message","dispatch"]),c=function(){return u({type:"SNACK_UNLOAD"})},i=ce();n=Object.keys(oe).includes(n)?n:"info";var s=oe[n];return a.a.createElement(Y.a,Object.assign({anchorOrigin:{vertical:"bottom",horizontal:"center"},open:t,onClose:c},o),a.a.createElement($.a,{className:Object(ue.a)(i[n]),"aria-describedby":"snackbar",message:a.a.createElement("span",{id:"snackbar",className:i.message},a.a.createElement(s,{className:Object(ue.a)(i.icon,i.iconVariant)}),r),action:[a.a.createElement(Q.a,{key:"close","aria-label":"close",color:"inherit",onClick:c},a.a.createElement(ne.a,{className:i.icon}))]}))})),se=n(154);function le(){var e=Object(f.a)(["\n  width: 80vw;\n  height: 80vh;\n"]);return le=function(){return e},e}function fe(e,t){return Math.floor(e/t)*t}function de(e,t){return function(n,r){for(var a=r-n;0!==a;){var u=Math.floor(a/2),o=n+u;t(e[o])?(a-=u+1,n=o+1):a=u}return n}(0,e.length)}function pe(e,t,n){var r=new N.a(e);if(2===r.header.getFormat())throw new Error("Unsupported format of MIDI");if(0===r.header.getTracksCount())throw new Error("Not enough tracks");if(r.header.getTimeDivision()!==N.a.Header.TICKS_PER_BEAT)throw new Error("Unsupported time division");var a,u=[],o=[],c=r.getMidiEvents(),i=Object(p.a)(c);try{for(i.s();!(a=i.n()).done;){var s=a.value;if(s.channel===n)switch(s.subtype){case w.a.EVENT_MIDI_NOTE_ON:if(u.length!==o.length)break;u.push([1e3*s.playTime,s.param1]);break;case w.a.EVENT_MIDI_NOTE_OFF:if(u.length-o.length!==1||u[u.length-1][1]!==s.param1)break;o.push([1e3*s.playTime,s.param1])}}}catch(h){i.e(h)}finally{i.f()}if(u.length!==o.length)throw new Error("Invalid # of note offs");for(var l=[],f=0;f<u.length;f++){var d=u[f],m=o[f];l.push({tpos:d[0],duration:m[0]-d[0],pitch:d[1]})}return l}function me(e,t,n){var r={notes:e.map((function(e){return[Math.round(e.tpos),Math.round(e.duration),Math.round(e.pitch)]})),youtubeVideoId:t,timeOffset:n};return JSON.stringify(r)}function he(){return ve.apply(this,arguments)}function ve(){return(ve=Object(d.a)(s.a.mark((function e(){var t,n,r,a,u;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new AudioContext,e.next=3,navigator.mediaDevices.getUserMedia({audio:!0,video:!1});case 3:return n=e.sent,e.next=6,new Promise((function(e){var r=S.a.pitchDetection("./model",t,n,(function(){e(r)}))}));case 6:return r=e.sent,a=function(){return new Promise((function(e,t){return r.getPitch((function(n,r){n&&t(n),r||e(null);var a=Math.round(Math.log(r/440)/Math.log(2)*12)+69;e(a)}))}))},u=function(){n.getTracks().forEach((function(e){return e.stop()})),t.close()},e.abrupt("return",[a,u]);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ge=v.a.svg(le());function be(e){var t,n,r,u=e.curtpos,o=e.gNotes,c=e.uNotes,i=e.seconds,s=100*i,l=function(e){return 100*e/1e6},f=fe(l(u),s),d=fe(l(u),s)+s,p=function(e){return l(e)-f},m=function(e,t){return e.filter((function(e){return f<l(e.tpos+e.duration)&&l(e.tpos)<d})).reduce((function(e,t){if(0===e.length)return[t];var n,r,a=e[e.length-1];return a.pitch===t.pitch&&(n=a.tpos+a.duration,r=t.tpos,Math.abs(n-r)<1e-4)?(e[e.length-1]={tpos:a.tpos,duration:t.tpos+t.duration-a.tpos,pitch:a.pitch},e):e.concat(t)}),[]).map((function(e){return a.a.createElement(a.a.Fragment,{key:e.tpos},a.a.createElement("rect",{x:p(e.tpos),y:500-5*e.pitch,width:l(e.duration),height:5,rx:1,ry:1,fill:t,fillOpacity:.7}))}))};return a.a.createElement(a.a.Fragment,null,a.a.createElement("p",null,u),a.a.createElement(ge,{viewBox:"0,0,"+s+",500",preserveAspectRatio:"none"},a.a.createElement("line",{x1:0,x2:s,y1:0,y2:0,strokeWidth:5,stroke:"gray"}),a.a.createElement("line",{x1:0,x2:s,y1:500,y2:500,strokeWidth:5,stroke:"gray"}),(t=0,n=s,r=100,Array.from({length:(n-t)/r+1},(function(e,n){return t+n*r}))).map((function(e){return a.a.createElement("line",{key:e,x1:e,x2:e,y1:0,y2:500,strokeWidth:1,stroke:"gray",fillOpacity:.7})})),a.a.createElement("line",{x1:p(u),x2:p(u),y1:0,y2:500,strokeWidth:1,stroke:"red"}),m(o,"gray"),m(c.filter((function(e){return e.correct})),"#FFA500"),m(c.filter((function(e){return!e.correct})),"red")))}function Ee(e){var t=e.dispatch,n=Object(r.useState)(""),u=Object(l.a)(n,2),o=u[0],c=u[1],i=Object(r.useState)(null),s=Object(l.a)(i,2),f=s[0],d=s[1];return a.a.createElement("div",null,a.a.createElement("textarea",{value:o,onChange:function(e){c(e.target.value);try{var n=JSON.parse(e.target.value),r=n.notes.map((function(e){return{tpos:e[0],duration:e[1],pitch:e[2]}})),a=n.youtubeVideoId,u=n.timeOffset;!("string"===typeof(o=a)||o instanceof String)||isNaN(u)?t({type:"SNACK_LOAD",message:"invalid JSON",variant:"error"}):(t({type:"SET_GAKUFU",gakufu:{notes:r,videoId:a}}),t({type:"SET_USER_TIME_OFFSET",value:u}),d(null))}catch(e){t({type:"RESET_GAKUFU"}),d(e.message),t({type:"SNACK_LOAD",message:e.message,variant:"error"})}var o;t({type:"RESET_USER_NOTES"})}}),f)}function Oe(e){var t=e.timeOffset,n=e.dispatch;return a.a.createElement("div",null,a.a.createElement("input",{type:"number",value:Math.floor(t/1e3),onChange:function(e){return n({type:"SET_USER_TIME_OFFSET",value:1e3*Number(e.target.value)})},required:!0}),"ms")}function ye(e){var t=e.pitchOffset,n=e.dispatch;return a.a.createElement("div",null,a.a.createElement("input",{type:"number",value:Math.floor(t),onChange:function(e){return n({type:"SET_USER_PITCH_OFFSET",value:Number(e.target.value)})},required:!0}),"note#")}function _e(e){var t=e.dispatch,n=e.gakufu,u=e.user,o=u.notes,c=u.timeOffset,i=u.pitchOffset,f=Object(r.useRef)(!1),p=Object(r.useRef)(c),m=Object(r.useRef)(i),h=Object(r.useState)(0),v=Object(l.a)(h,2),g=v[0],E=v[1],O=Object(r.useRef)(null),y=Object(r.useCallback)(Object(d.a)(s.a.mark((function e(){var r,a,u,o,c,i,d,h,v,g,b,y,_,j,S;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!f.current){e.next=2;break}return e.abrupt("return");case 2:return f.current=!0,r=setInterval((function(){return E(1e3*O.current.getCurrentTime()*1e3)}),25),e.next=6,he();case 6:a=e.sent,u=Object(l.a)(a,2),o=u[0],c=u[1],t({type:"RESET_USER_NOTES"}),d=(i=function(){return 1e6*O.current.getCurrentTime()-p.current})();case 13:if(!f.current){e.next=22;break}return e.next=16,o();case 16:h=e.sent,v=i(),h&&(g=v-d,b=h,y=!1,_=de(n.notes,(function(e){return e.tpos<d}))-1,(j=_>=0?n.notes[_]:n.notes[0])&&(b=j.pitch+m.current,(S=h-b-12*Math.floor((h-b)/12))>6&&(S-=12),b+=S,j.tpos<d&&d<j.tpos+j.duration&&0===S&&(y=!0)),t({type:"APPEND_USER_NOTE",note:{tpos:d,duration:g,pitch:b,correct:y}})),d=v,e.next=13;break;case 22:c(),clearInterval(r);case 24:case"end":return e.stop()}}),e)}))),[n.notes,t]);return p.current=c,m.current=i,a.a.createElement(a.a.Fragment,null,n.midiBuf&&a.a.createElement(G,{buffer:n.midiBuf,onReady:function(e){return O.current=e.target},onPlay:y,onEnd:function(){return f.current=!1}}),n.videoId&&a.a.createElement(b.a,{videoId:n.videoId,onReady:function(e){return O.current=e.target},onPlay:y,onPause:function(){return f.current=!1},onEnd:function(){return f.current=!1}}),n.notes&&a.a.createElement(be,{curtpos:g,gNotes:n.notes,uNotes:o,seconds:30}))}function je(e){var t=e.gNotes,n=e.uNotes;if(!t||!n)return a.a.createElement("div",null);var r=1.2*(100*(n.reduce((function(e,n){var r=t[de(t,(function(e){return e.tpos<n.tpos}))-1];if(!r||r.tpos+r.duration<n.tpos)return e;var a,u=Math.abs(n.pitch-r.pitch);return e+n.duration*(1-(a=u)/(1+Math.abs(a)))}),0)/t.reduce((function(e,t){return e+t.duration}),0))+0);return a.a.createElement("div",null,"Score: ",Math.round(100*r)/100)}function Se(e){var t=e.dispatch,n=Object(r.useState)(null),u=Object(l.a)(n,2),o=u[0],c=u[1],i=Object(r.useState)(0),s=Object(l.a)(i,2),f=s[0],d=s[1],p=Object(r.useState)(0),m=Object(l.a)(p,2),h=m[0],v=m[1],g=Object(r.useState)(0),E=Object(l.a)(g,2),O=E[0],y=E[1],_=Object(r.useState)(0),j=Object(l.a)(_,2),S=j[0],k=j[1],N=Object(r.useState)(null),T=Object(l.a)(N,2),w=T[0],C=T[1],x=Object(r.useState)(null),A=Object(l.a)(x,2),R=A[0],I=A[1],M=Object(r.useRef)(null),U=[],F=[];if(o)try{F=function(e,t,n){if(0===e.length)return e;var r=e[0].tpos;return e.map((function(e){return{tpos:e.tpos-r+t,duration:e.duration,pitch:e.pitch+n}}))}(U=pe(o,0,h),1e6*O,S),M.current=null}catch(P){M.current=P.message}return Object(r.useEffect)((function(){if(0!==U.length){var e=U[0].tpos/1e6;y(e)}}),[o,f,h]),Object(r.useEffect)((function(){R&&R.seekTo(O,!0)}),[R,O]),a.a.createElement("div",null,a.a.createElement("div",null,a.a.createElement("input",{type:"file",accept:"audio/midi, audio/x-midi, audio/mid",onChange:function(e){c(null),d(0),v(0),y(0),k(0),C(null),I(null),M.current=null;var n=e.target.files[0];W(n,c,t)}})),a.a.createElement("div",null,a.a.createElement("label",null,"Track No.:",a.a.createElement("input",{type:"number",onChange:function(e){return d(Number(e.target.value))},value:f})),a.a.createElement("label",null,"Channel No.:",a.a.createElement("input",{type:"number",onChange:function(e){return v(Number(e.target.value))},value:h}))),a.a.createElement("div",null,a.a.createElement("label",null,"YouTube video id:",a.a.createElement("input",{type:"text",onChange:function(e){return C(e.target.value)},value:w||""}))),a.a.createElement("div",null,a.a.createElement("label",null,"intro time (sec):",a.a.createElement("input",{type:"number",step:"any",onChange:function(e){return y(Number(e.target.value))},value:O})),a.a.createElement("label",null,"pitch offset (SMF note #):",a.a.createElement("input",{type:"number",onChange:function(e){return k(Number(e.target.value))},value:S}))),a.a.createElement("div",null,a.a.createElement("textarea",{value:o&&w?me(F,w,3e5):"",readOnly:!0})),a.a.createElement("p",null,M.current),o&&w?a.a.createElement(b.a,{videoId:w,onReady:function(e){var t=e.target;I(t),t.playVideo(),t.pauseVideo()}}):a.a.createElement("div",null),a.a.createElement(be,{curtpos:0,gNotes:F,uNotes:[],seconds:60}))}Ee=Object(h.b)()(Ee),Oe=Object(h.b)((function(e){return{timeOffset:e.user.timeOffset}}))(Oe),ye=Object(h.b)((function(e){return{pitchOffset:e.user.pitchOffset}}))(ye),_e=Object(h.b)((function(e){return{gakufu:e.gakufu,user:e.user}}))(_e),je=Object(h.b)((function(e){return{gNotes:e.gakufu.notes,uNotes:e.user.notes}}))(je),Se=Object(h.b)()(Se);var ke=Object(m.b)({gakufu:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{notes:null,videoId:null,midiBuf:null},t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SET_GAKUFU":return t.gakufu;case"RESET_GAKUFU":return{notes:null,videoId:null};default:return e}},user:Object(E.a)({key:"user",storage:y.a,whitelist:["pitchOffset"]},(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{notes:[],timeOffset:3e5,pitchOffset:0},t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SET_USER_TIME_OFFSET":return Object(c.a)({},e,{timeOffset:t.value});case"SET_USER_PITCH_OFFSET":return Object(c.a)({},e,{pitchOffset:t.value});case"RESET_USER_NOTES":return Object(c.a)({},e,{notes:[]});case"APPEND_USER_NOTE":return Object(c.a)({},e,{notes:e.notes.concat(t.note)});default:return e}})),snack:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{loadSnack:!1,message:"",variant:""},t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SNACK_LOAD":return console.log("loaded",t),Object(c.a)({},e,{openSnack:!0,message:t.message,variant:t.variant});case"SNACK_UNLOAD":return console.log("unloaded",t),Object(c.a)({},e,{openSnack:!1});default:return e}}}),Ne=Object(E.a)({key:"root",storage:y.a,whitelist:["user"]},ke),Te=Object(m.c)(Ne),we=Object(E.b)(Te);var Ce=function(){return a.a.createElement(h.a,{store:Te},a.a.createElement(_.a,{loading:null,persistor:we},a.a.createElement(se.a,null),a.a.createElement(Ee,null),a.a.createElement(H,{onLoad:function(e){Te.dispatch({type:"SET_GAKUFU",gakufu:{notes:pe(e,0,0),midiBuf:e,videoId:null}})}}),a.a.createElement(Oe,null),a.a.createElement(ye,null),a.a.createElement(je,null),a.a.createElement(_e,null),a.a.createElement("hr",null),a.a.createElement(Se,null),a.a.createElement(ie,null)))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(a.a.createElement(a.a.StrictMode,null,a.a.createElement(Ce,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},78:function(e,t,n){e.exports=n(124)},83:function(e,t,n){}},[[78,1,2]]]);
//# sourceMappingURL=main.20cc3412.chunk.js.map